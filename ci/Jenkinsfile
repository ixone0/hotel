pipeline {
  agent any

  environment {
    IMAGE_TAG = "${BUILD_NUMBER}"
    REGISTRY  = "ghcr.io/ixone0"
    WORKDIR   = "${env.WORKSPACE}"
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Login GHCR') {
      steps {
        withCredentials([usernamePassword(
          credentialsId: 'ghcr-creds',
          usernameVariable: 'GHCR_USER',
          passwordVariable: 'GHCR_TOKEN'
        )]) {
          sh 'echo $GHCR_TOKEN | docker login ghcr.io -u $GHCR_USER --password-stdin'
        }
      }
    }

    stage('Build & Push') {
      steps {
        dir("${WORKDIR}") {
          sh '''
            docker build -t $REGISTRY/hotel-backend:$IMAGE_TAG backend
            docker build -t $REGISTRY/hotel-frontend:$IMAGE_TAG frontend

            docker push $REGISTRY/hotel-backend:$IMAGE_TAG
            docker push $REGISTRY/hotel-frontend:$IMAGE_TAG
          '''
        }
      }
    }

    stage('Prepare Prod Env File') {
      steps {
        dir("${WORKDIR}") {
          withCredentials([
            file(credentialsId: 'env-prod-file', variable: 'ENV_PROD_FILE')
          ]) {
            sh '''
              cp $ENV_PROD_FILE .env.prod

              # ensure IMAGE_TAG matches current build
              if grep -q "^IMAGE_TAG=" .env.prod; then
                sed -i "s/^IMAGE_TAG=.*/IMAGE_TAG=$IMAGE_TAG/" .env.prod
              else
                echo "IMAGE_TAG=$IMAGE_TAG" >> .env.prod
              fi

              ls -la .env.prod
            '''
          }
        }
      }
    }

    stage('Deploy') {
      steps {
        dir("${WORKDIR}") {
          sh '''
            export IMAGE_TAG=$IMAGE_TAG

            docker compose \
              -f compose/docker-compose.prod.yml \
              --env-file .env.prod \
              -p hotel down || true

            docker compose \
              -f compose/docker-compose.prod.yml \
              --env-file .env.prod \
              -p hotel pull

            docker compose \
              -f compose/docker-compose.prod.yml \
              --env-file .env.prod \
              -p hotel up -d
          '''
        }
      }
    }

    stage('Cleanup') {
      steps {
        dir("${WORKDIR}") {
          sh 'rm -f .env.prod'
        }
      }
    }
  }
}
